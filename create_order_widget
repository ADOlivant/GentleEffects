from PyQt4.QtCore import *
from PyQt4.QtGui import *
from PyQt4.QtSql import *

import sys
import datetime

from search_customer_widget import *

class CreateOrder(QWidget):
    """This is a widget which enable the end user to create an order."""

    productSelectedSignal = pyqtSignal()
    
    def __init__(self,connection):
        super().__init__()

        self.connection = connection

        self.stacked_order_layout = QStackedLayout()
        self.setLayout(self.stacked_order_layout)

        self.now = datetime.now()

        self.find_customer_layout()

        #connections
        self.productSelectedSignal(self.product_selected)

    def find_customer_layout(self):
        self.search_customer_layout = SearchCustomer()
        self.stacked_order_layout.addWidget(self.search_customer_layout)
        self.stacked_order_layout.setCurrentIndex(0)

        #connections
        self.search_customer_layout.customerSelectedSignal.connect(self.create_order)

    def create_order(self):
        details = self.order_details_default()
        self.connection.create_order(details)
        self.order_id = self.find_order_id()
        self.create_order_layout()

    def order_details_default(self):
        details = {'DateOfOrder':self.now,
                   'CustomerID':self.search_customer_layout.customer_view.model().data(self.search_customer_layout.index[0]),
                   'Ordered':"False",
                   'Delivered':"False"}
        return details

    def create_order_layout(self):
        #TITLE FOR LAYOUT
        self.order_title_label = QLabel("""<html>
					  <body>
					       <p><span style=" font-size:16pt; font-weight:1000; color:Green">New Order</span></p>
					  </body>
				     </html>""")
        self.create_order_button = QPushButton("Create Order")
        self.create_order_button.hide()

        self.order_error_message = QLabel()
        self.order_error_message.hide()

        #CUSTOMER DETAILS LAYOUT
        self.customer_details_label = QLabel("""<html>
					  <body>
					       <p><span style=" font-size:12pt; font-weight:750;">Customer Details</span></p>
					  </body>
				     </html>""")
        
        self.customer_data = self.get_customer_details()
        self.customer_id_label = QLabel("ID: {0}".format(self.customer_data['CustomerID']))
        self.customer_name_label = QLabel("Name: {0}, {1}".format(self.customer_data['LastName'],self.customer_data['FirstName']))
        self.customer_dob_label = QLabel("Date of Birth: {0}".format(self.customer_data['DateOfBirth']))
        self.customer_address_label = QLabel("Address: {0} {1}, \n                {2}, \n                {3}, \n                {4}".format(self.customer_data['House'],
                                                                                            self.customer_data['Road'],
                                                                                            self.customer_data['City'],
                                                                                            self.customer_data['County'],
                                                                                            self.customer_data['Postcode']))
        self.customer_contact_label = QLabel("Contact Numbers: {0}, {1} - Preferred: {2}".format(self.customer_data['Mobile'],
                                                                                                 self.customer_data['Home'],
                                                                                                 self.customer_data['Prefered']))
        self.customer_email_label = QLabel("Email: {0}".format(self.customer_data['Email']))
        self.customer_email_button = QPushButton("Email Customer")

        self.customer_details_layout = QGridLayout()
        self.customer_details_layout.addWidget(self.customer_details_label,0,0,1,2)
        self.customer_details_layout.addWidget(self.customer_name_label,1,0)
        self.customer_details_layout.addWidget(self.customer_id_label,1,1)
        self.customer_details_layout.addWidget(self.customer_dob_label,2,0,1,2)
        self.customer_details_layout.addWidget(self.customer_address_label,3,0,1,2)
        self.customer_details_layout.addWidget(self.customer_contact_label,4,0,1,2)
        self.customer_details_layout.addWidget(self.customer_email_label,5,0)
        self.customer_details_layout.addWidget(self.customer_email_button,5,1)
        self.customer_details_widget = QWidget()
        self.customer_details_widget.setLayout(self.customer_details_layout)

        

        #OVERALL LAYOUT
        self.add_product_button = QPushButton("Add Product")

        self.current_products = QTableView()

        self.product_selection = QTableView()
        self.current_products_model = self.connection.current_order_items_model()
        self.current_products.setModel(self.current_products_model)
        
        self.layout = QGridLayout()
        self.layout.addWidget(self.order_title_label,0,0,1,2)
        self.layout.addWidget(self.order_error_message,1,0,1,2)
        self.layout.addWidget(self.customer_details_widget,2,0)
        self.layout.addWidget(self.add_product_button,3,0,1,2)
        self.layout.addWidget(self.current_products,4,0,1,2)

        self.widget = QWidget()
        self.widget.setLayout(self.layout)
        self.stacked_order_layout.addWidget(self.widget)
        self.stacked_order_layout.setCurrentIndex(1)
